import { useMemo, useState } from "react";
import type {NavBarProps } from "../../types/NavBarType";
import ItemsBar from "../ItemsBar/ItemsBar";
import Member from "../Member/Member";
import "./NavBar.css";
import { useNavigate } from "react-router";
import { useSelector } from "react-redux";
import type { RootState } from "../../redux/store";

const NavBar = ({ items }: NavBarProps) => {
  const [activeItem, setActiveItem] = useState<string>("");
  const [menuOpen, setMenuOpen] = useState(false);
  const navigate = useNavigate();

interface MemberType {
  id: string;
  username: string;
  avatar?: string;
  role?: string;
}

interface GroupType {
  id: string;
  name: string;
  ownerID: string;
  members?: MemberType[];
}

const groups = useSelector((state: RootState) => state.group.groups as GroupType[]);
const userID = useSelector((state: RootState) => state.auth.userID);

  // Obtener los tres primeros miembros de cada grupo en el que el usuario estÃ¡
const memberAvatars = useMemo(() => {
  const allMembersMap: Record<string, { avatar: string; name: string; color?: string }> = {};

  groups.forEach(group => {
    const members = group.members ?? [];
    const isInGroup = group.ownerID === userID || members.some(m => m.id === userID);

    if (isInGroup) {
      members.slice(0, 3).forEach(m => {
        if (!allMembersMap[m.id]) { // solo agregamos si no existe
          allMembersMap[m.id] = {
            avatar: m.avatar || "",
            name: m.username,
            color: "#82C2F6",
          };
        }
      });
    }
    });

    // convertir a array y limitar a 3 miembros globalmente
    return Object.values(allMembersMap).slice(0, 3);
  }, [groups, userID]);

  return (
    <div
      className="nav-bar">
        <div className="logo" onClick={() => {navigate('/groups')}}>
          <svg width="125" height="47" viewBox="0 0 125 47" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M114.802 45.1682V14.1591L123.923 16.6578V45.1682H114.802ZM122.023 7.62413C121.981 8.13668 121.221 8.79872 119.743 9.61025C118.265 10.3791 116.998 10.6353 115.942 10.3791C115.393 10.2509 114.95 9.9733 114.612 9.54618C114.485 9.41804 114.401 9.33262 114.359 9.28991C113.683 8.26481 113.345 7.13294 113.345 5.89428C113.345 4.27122 113.915 2.88307 115.055 1.72984C116.195 0.576615 117.568 0 119.173 0C120.777 0 122.15 0.576615 123.29 1.72984C124.43 2.88307 125 4.29258 125 5.95835C125 7.58142 124.43 8.96956 123.29 10.1228C122.15 11.276 120.777 11.8526 119.173 11.8526C118.624 11.8526 118.096 11.7672 117.589 11.5964C118.434 11.6391 119.194 11.4682 119.869 11.0838C120.587 10.6567 121.136 10.1441 121.516 9.54618C121.938 8.90549 122.107 8.26481 122.023 7.62413Z" fill="#2B438D"/>
          <path d="M114.056 14.4794L103.351 25.7555L114.056 45.04L105.061 45.1682L97.4601 31.2653L97.0167 31.7779V45.1682H87.7687V0L97.0167 2.17832V24.346L106.771 14.4794H114.056Z" fill="#2B438D"/>
          <path d="M73.3057 25.3073C76.0928 26.5459 78.4576 27.9127 80.4001 29.4076C82.3426 30.8599 83.7572 32.3121 84.644 33.7643C85.5308 35.1738 85.9953 36.5619 86.0375 37.9287C86.0798 39.2955 85.5941 40.5555 84.5807 41.7088C83.5672 42.8193 82.0892 43.7376 80.1467 44.4637C78.2042 45.1898 76.0083 45.5742 73.5591 45.6169C71.1099 45.7023 68.8084 45.4888 66.6548 44.9762C64.5011 44.421 62.6853 43.4386 61.2073 42.0291C59.7294 40.6196 58.9904 38.9325 58.9904 36.9677C58.9904 36.2416 59.0537 35.5796 59.1804 34.9816C59.3493 34.3836 59.5393 33.9138 59.7505 33.5721C60.0038 33.1877 60.2572 32.846 60.5106 32.547C60.8062 32.248 61.0807 32.0131 61.334 31.8422C61.6296 31.6714 61.883 31.5433 62.0941 31.4578C62.3475 31.3724 62.5375 31.3083 62.6642 31.2656L62.8542 31.2016L72.2289 35.6863C72.1867 35.6863 72.1022 35.7077 71.9755 35.7504C71.8911 35.7504 71.7222 35.7718 71.4688 35.8145C71.2154 35.8572 70.9621 35.9213 70.7087 36.0067C70.4975 36.0921 70.2442 36.2202 69.9486 36.3911C69.653 36.5192 69.3996 36.6901 69.1885 36.9036C68.9773 37.0745 68.7873 37.3094 68.6184 37.6084C68.4917 37.8647 68.4284 38.1636 68.4284 38.5053C68.3861 39.9576 69.0407 41.0894 70.392 41.901C71.7433 42.6698 73.0946 42.7125 74.4459 42.0291C75.8394 41.3457 76.5573 39.9148 76.5995 37.7365C76.5995 36.8396 76.0506 35.9853 74.9526 35.1738C73.8969 34.3623 72.6301 33.6789 71.1521 33.1236C69.7163 32.5256 68.0483 31.7568 66.148 30.8171C64.29 29.8348 62.7909 28.8097 61.6507 27.7419C60.595 26.7595 59.856 25.6703 59.4338 24.4744C59.0115 23.2357 58.9904 22.0184 59.3704 20.8225C59.7505 19.5838 60.4472 18.4733 61.4607 17.4909C62.4742 16.4658 63.9733 15.633 65.958 14.9923C67.985 14.3516 70.3497 14.0312 73.0524 14.0312C78.4998 14.0312 82.3003 15.3126 84.454 17.8753C86.6076 20.3954 86.5443 23.8551 84.2639 28.2544L73.8758 23.5134C74.467 23.1717 75.0371 22.7018 75.586 22.1039C76.135 21.4632 76.5573 20.8225 76.8529 20.1818C77.1485 19.4984 77.1063 18.9004 76.7262 18.3879C76.3884 17.8753 75.6494 17.555 74.5092 17.4269C73.538 17.2987 72.5878 17.3628 71.6588 17.6191C70.7298 17.8753 69.9908 18.2811 69.4418 18.8364C68.9351 19.3916 68.6395 20.011 68.5551 20.6944C68.4706 21.335 68.8295 22.0825 69.6319 22.9367C70.4342 23.791 71.6588 24.5812 73.3057 25.3073Z" fill="#2B438D"/>
          <path d="M19.8261 45.1682C14.5476 45.1682 11.9084 45.1682 11.9084 45.1682V43.5024V45.1682C9.75471 45.2963 8.02336 44.9759 6.71428 44.2071C5.40521 43.3956 4.41285 42.0502 3.7372 40.1708C3.10377 38.2488 2.78706 35.686 2.78706 32.4826V18.1954H1.07682L0 14.4794H2.78706V0L11.9717 2.69087V14.4794H17.4825V18.1954H11.9717V25.1788C11.9717 28.6385 11.9717 32.3118 11.9717 36.1986C12.0562 38.5478 12.9429 40.6407 14.6321 42.4773C16.3212 44.2712 18.0526 45.1682 19.8261 45.1682Z" fill="#2B438D"/>
          <ellipse cx="30.0879" cy="20.6621" rx="2.69205" ry="5.28563" fill="#C090F0"/>
          <path d="M51.782 22.1035C51.782 34.134 44.9403 43.8867 36.5007 43.8867C28.061 43.8867 21.2194 34.134 21.2194 22.1035" stroke="#C090F0" strokeWidth="5.60598" strokeLinecap="square"/>
          <path d="M37.3711 21.7831C38.4796 21.7831 41.0092 21.875 43.217 23.6788C43.8637 21.3827 45.4044 16.2713 49.9604 15.7767" stroke="#C090F0" strokeWidth="2.08222"/>
          <path d="M51.7044 23.2246C52.1886 23.8062 48.9294 38.5322 54.2133 42.7575C56.9396 44.9377 59.8582 42.7575 59.8582 42.7575" stroke="#C090F0" strokeWidth="5.60598"/>
          </svg>
        </div>
        <div className="logo-responsive" onClick={() => {navigate('/groups')}}>
          <svg width="62" height="24" viewBox="0 0 62 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M56.9418 22.4034V7.02292L61.466 8.26225V22.4034H56.9418ZM60.5235 3.78157C60.5025 4.0358 60.1255 4.36417 59.3924 4.76669C58.6594 5.14802 58.031 5.27513 57.5074 5.14802C57.2351 5.08447 57.0152 4.94676 56.8476 4.73491C56.7848 4.67135 56.7429 4.62898 56.7219 4.6078C56.3868 4.09935 56.2192 3.53794 56.2192 2.92357C56.2192 2.11853 56.502 1.43001 57.0675 0.858007C57.633 0.286005 58.3138 3.8147e-06 59.1097 3.8147e-06C59.9056 3.8147e-06 60.5863 0.286005 61.1518 0.858007C61.7174 1.43001 62.0001 2.12912 62.0001 2.95535C62.0001 3.76039 61.7174 4.44891 61.1518 5.02091C60.5863 5.59291 59.9056 5.87891 59.1097 5.87891C58.8374 5.87891 58.5756 5.83654 58.3242 5.7518C58.7431 5.77299 59.1201 5.68825 59.4553 5.49758C59.8113 5.28572 60.0836 5.0315 60.2721 4.73491C60.4816 4.41713 60.5654 4.09935 60.5235 3.78157Z" fill="white"/>
            <path d="M56.5716 7.1818L51.262 12.7747L56.5716 22.3399L52.1103 22.4034L48.3401 15.5076L48.1202 15.7618V22.4034H43.5332V3.8147e-06L48.1202 1.08045V12.0756L52.9585 7.1818H56.5716Z" fill="white"/>
            <path d="M36.3597 12.5523C37.7421 13.1666 38.915 13.8446 39.8785 14.586C40.842 15.3063 41.5436 16.0266 41.9835 16.7469C42.4233 17.446 42.6537 18.1346 42.6747 18.8125C42.6956 19.4904 42.4548 20.1154 41.9521 20.6874C41.4494 21.2382 40.7163 21.6937 39.7528 22.0538C38.7893 22.414 37.7002 22.6047 36.4854 22.6258C35.2705 22.6682 34.129 22.5623 33.0608 22.3081C31.9926 22.0327 31.092 21.5454 30.3589 20.8463C29.6258 20.1472 29.2593 19.3103 29.2593 18.3358C29.2593 17.9757 29.2907 17.6473 29.3535 17.3507C29.4373 17.0541 29.5316 16.8211 29.6363 16.6516C29.762 16.4609 29.8876 16.2915 30.0133 16.1432C30.1599 15.9949 30.2961 15.8783 30.4217 15.7936C30.5684 15.7089 30.694 15.6453 30.7987 15.6029C30.9244 15.5606 31.0187 15.5288 31.0815 15.5076L31.1758 15.4758L35.8256 17.7003C35.8047 17.7003 35.7628 17.7109 35.6999 17.732C35.658 17.732 35.5743 17.7426 35.4486 17.7638C35.3229 17.785 35.1972 17.8168 35.0716 17.8592C34.9668 17.9015 34.8412 17.9651 34.6946 18.0498C34.5479 18.1134 34.4223 18.1981 34.3175 18.304C34.2128 18.3888 34.1186 18.5053 34.0348 18.6536C33.9719 18.7807 33.9405 18.929 33.9405 19.0985C33.9196 19.8188 34.2442 20.3802 34.9145 20.7827C35.5847 21.1641 36.255 21.1852 36.9252 20.8463C37.6164 20.5073 37.9725 19.7976 37.9934 18.7172C37.9934 18.2723 37.7211 17.8486 37.1766 17.446C36.6529 17.0435 36.0246 16.7046 35.2915 16.4292C34.5794 16.1326 33.752 15.7512 32.8095 15.2852C31.8879 14.7979 31.1443 14.2894 30.5788 13.7598C30.0552 13.2726 29.6887 12.7323 29.4792 12.1391C29.2698 11.5248 29.2593 10.921 29.4478 10.3278C29.6363 9.71343 29.9819 9.16261 30.4846 8.67535C30.9873 8.16691 31.7308 7.75379 32.7152 7.43601C33.7206 7.11824 34.8935 6.95935 36.234 6.95935C38.936 6.95935 40.821 7.5949 41.8892 8.86602C42.9574 10.1159 42.926 11.832 41.795 14.014L36.6425 11.6625C36.9357 11.493 37.2185 11.26 37.4907 10.9634C37.763 10.6456 37.9725 10.3278 38.1191 10.01C38.2657 9.67106 38.2448 9.37446 38.0563 9.12024C37.8887 8.86602 37.5222 8.70713 36.9566 8.64357C36.4749 8.58002 36.0036 8.6118 35.5428 8.73891C35.082 8.86602 34.7155 9.06728 34.4432 9.34269C34.1919 9.6181 34.0453 9.92528 34.0034 10.2642C33.9615 10.582 34.1395 10.9528 34.5375 11.3765C34.9354 11.8002 35.5428 12.1921 36.3597 12.5523Z" fill="white"/>
            <path d="M9.83377 22.4034C7.21562 22.4034 5.90654 22.4034 5.90654 22.4034V21.5772V22.4034C4.83834 22.467 3.97959 22.3081 3.33029 21.9267C2.68098 21.5242 2.18877 20.8569 1.85365 19.9247C1.53947 18.9714 1.38238 17.7003 1.38238 16.1114V9.02492H0.534102L0 7.1818H1.38238V0L5.93796 1.33467V7.1818H8.67131V9.02492H5.93796V12.4887C5.93796 14.2047 5.93796 16.0266 5.93796 17.9545C5.97985 19.1197 6.4197 20.1578 7.25751 21.0687C8.09532 21.9585 8.95407 22.4034 9.83377 22.4034Z" fill="white"/>
            <ellipse cx="14.9236" cy="10.2484" rx="1.33526" ry="2.62168" fill="white"/>
            <path d="M25.684 10.9634C25.684 16.9306 22.2905 21.7679 18.1044 21.7679C13.9184 21.7679 10.5249 16.9306 10.5249 10.9634" stroke="white" strokeWidth="2.78056" strokeLinecap="square"/>
            <path d="M18.5361 10.8044C19.0859 10.8044 20.3406 10.85 21.4357 11.7447C21.7564 10.6058 22.5206 8.07057 24.7804 7.82525" stroke="white" strokeWidth="1.03278"/>
            <path d="M25.6453 11.5195C25.8855 11.8079 24.2689 19.112 26.8897 21.2078C28.242 22.2891 29.6896 21.2078 29.6896 21.2078" stroke="white" strokeWidth="2.78056"/>
          </svg>
        </div>
        <div className="responsive-icons">
          <div className="user-responsive" onClick={() => navigate("/profile")}>
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 10C12.7614 10 15 7.76142 15 5C15 2.23858 12.7614 0 10 0C7.23858 0 5 2.23858 5 5C5 7.76142 7.23858 10 10 10ZM13.3333 5C13.3333 6.84095 11.8409 8.33333 10 8.33333C8.15905 8.33333 6.66667 6.84095 6.66667 5C6.66667 3.15905 8.15905 1.66667 10 1.66667C11.8409 1.66667 13.3333 3.15905 13.3333 5Z" fill="white"/>
              <path d="M20 18.3333C20 20 18.3333 20 18.3333 20H1.66667C1.66667 20 0 20 0 18.3333C0 16.6667 1.66667 11.6667 10 11.6667C18.3333 11.6667 20 16.6667 20 18.3333ZM18.3333 18.3275C18.3309 17.9162 18.077 16.6841 16.9465 15.5535C15.8594 14.4664 13.8152 13.3333 9.99998 13.3333C6.1848 13.3333 4.14059 14.4664 3.05349 15.5535C1.92292 16.6841 1.66904 17.9162 1.66667 18.3275H18.3333Z" fill="white"/>
            </svg>
          </div>
          <div className={"hamburger-menu"} onClick={() => setMenuOpen(!menuOpen)}>
              <svg width="19" height="21" viewBox="0 0 19 21" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fillRule="evenodd" clipRule="evenodd" d="M0.875 19.2188C0.875 18.6837 1.1968 18.25 1.59375 18.25H17.4062C17.8032 18.25 18.125 18.6837 18.125 19.2188C18.125 19.7538 17.8032 20.1875 17.4062 20.1875H1.59375C1.1968 20.1875 0.875 19.7538 0.875 19.2188Z" fill="white"/>
              <path fillRule="evenodd" clipRule="evenodd" d="M0.875 13.4062C0.875 12.8712 1.1968 12.4375 1.59375 12.4375H17.4062C17.8032 12.4375 18.125 12.8712 18.125 13.4062C18.125 13.9413 17.8032 14.375 17.4062 14.375H1.59375C1.1968 14.375 0.875 13.9413 0.875 13.4062Z" fill="white"/>
              <path fillRule="evenodd" clipRule="evenodd" d="M0.875 7.59375C0.875 7.05872 1.1968 6.625 1.59375 6.625H17.4062C17.8032 6.625 18.125 7.05872 18.125 7.59375C18.125 8.12878 17.8032 8.5625 17.4062 8.5625H1.59375C1.1968 8.5625 0.875 8.12878 0.875 7.59375Z" fill="white"/>
              <path fillRule="evenodd" clipRule="evenodd" d="M0.875 1.78125C0.875 1.24622 1.1968 0.8125 1.59375 0.8125H17.4062C17.8032 0.8125 18.125 1.24622 18.125 1.78125C18.125 2.31628 17.8032 2.75 17.4062 2.75H1.59375C1.1968 2.75 0.875 2.31628 0.875 1.78125Z" fill="white"/>
              </svg>
          </div>
        </div>
        <div className={items-bar ${menuOpen ? "open" : ""}}>
          {items.map((item, index) => (
            <ItemsBar
              key={index}
              icon={item.icon}
              text={item.text}
              isActive={activeItem === item.text}
              onClick={() => {
                setActiveItem(item.text);
                if (item.path) navigate(item.path); 
              }}
            />
          ))}
        </div>
        <div className="avatars-bar">
          <h3>Members</h3>
          <div className="members">
            {memberAvatars.map((avatar, index) => (
                <Member key={index} avatar={avatar.avatar} name={avatar.name} color={avatar.color} />
            ))}
          </div>
        </div>
    </div>
  );
};

export default NavBar;